# Latest Comments Feed Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add a global "Latest Comments" feed inside the Chrome extension drawer so users can browse recent comments across all car listings.

**Architecture:** New `listings` table stores car metadata scraped from the page DOM. Content script broadened to all polovniautomobili.com pages. Drawer gets tab navigation: "–û–≤–∞—ò –æ–≥–ª–∞—Å" (per-listing) and "–ù–∞—ò–Ω–æ–≤–∏—ò–µ" (global feed). Feed is read-only with clickable car preview cards.

**Tech Stack:** Convex (schema, queries, mutations), React, TypeScript, Tailwind CSS, Chrome Extension Manifest V3

---

### Task 1: Add `listings` table to schema and `by_createdAt` index on comments

**Files:**
- Modify: `extension/convex/schema.ts`

**Step 1: Update the schema**

Add the `listings` table and the new index on `comments`:

```typescript
import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  comments: defineTable({
    listingId: v.string(),
    authorId: v.string(),
    text: v.string(),
    createdAt: v.number(),
    parentId: v.optional(v.id("comments")),
    username: v.string(),
    isAutoGenerated: v.boolean(),
  })
    .index("by_listing", ["listingId"])
    .index("by_parent", ["parentId"])
    .index("by_createdAt", ["createdAt"]),

  votes: defineTable({
    commentId: v.id("comments"),
    voterId: v.string(),
    direction: v.union(v.literal("up"), v.literal("down")),
  })
    .index("by_comment", ["commentId"])
    .index("by_comment_voter", ["commentId", "voterId"]),

  listings: defineTable({
    listingId: v.string(),
    title: v.string(),
    price: v.string(),
    imageUrl: v.string(),
    url: v.string(),
  }).index("by_listingId", ["listingId"]),
});
```

**Step 2: Build and verify**

Run: `npm run build && rm -f convex/*.js`
Expected: Build succeeds. Convex will create the new table and index on next deploy/push.

**Step 3: Commit**

```bash
git add extension/convex/schema.ts
git commit -m "feat: add listings table and by_createdAt index on comments"
```

---

### Task 2: Add `upsertListing` mutation

**Files:**
- Create: `extension/convex/listings.ts`

**Step 1: Create the listings mutation file**

```typescript
import { v } from "convex/values";
import { mutation } from "./_generated/server";

export const upsertListing = mutation({
  args: {
    listingId: v.string(),
    title: v.string(),
    price: v.string(),
    imageUrl: v.string(),
    url: v.string(),
  },
  handler: async (ctx, args) => {
    const existing = await ctx.db
      .query("listings")
      .withIndex("by_listingId", (q) => q.eq("listingId", args.listingId))
      .first();

    if (existing) {
      await ctx.db.patch(existing._id, {
        title: args.title,
        price: args.price,
        imageUrl: args.imageUrl,
        url: args.url,
      });
      return existing._id;
    }

    return ctx.db.insert("listings", args);
  },
});
```

**Step 2: Build and verify**

Run: `npm run build && rm -f convex/*.js`
Expected: Build succeeds.

**Step 3: Commit**

```bash
git add extension/convex/listings.ts
git commit -m "feat: add upsertListing mutation"
```

---

### Task 3: Add `getLatestComments` query

**Files:**
- Modify: `extension/convex/comments.ts`

**Step 1: Add the query**

Add this after the existing `postComment` mutation in `extension/convex/comments.ts`:

```typescript
export const getLatestComments = query({
  args: {},
  handler: async (ctx) => {
    const comments = await ctx.db
      .query("comments")
      .withIndex("by_createdAt")
      .order("desc")
      .filter((q) => q.eq(q.field("parentId"), undefined))
      .take(50);

    const withListings = await Promise.all(
      comments.map(async (comment) => {
        const listing = await ctx.db
          .query("listings")
          .withIndex("by_listingId", (q) =>
            q.eq("listingId", comment.listingId)
          )
          .first();

        return {
          _id: comment._id,
          text: comment.text,
          username: comment.username,
          isAutoGenerated: comment.isAutoGenerated,
          createdAt: comment.createdAt,
          listing: listing
            ? {
                title: listing.title,
                price: listing.price,
                imageUrl: listing.imageUrl,
                url: listing.url,
              }
            : null,
        };
      })
    );

    return withListings;
  },
});
```

**Step 2: Build and verify**

Run: `npm run build && rm -f convex/*.js`
Expected: Build succeeds.

**Step 3: Commit**

```bash
git add extension/convex/comments.ts
git commit -m "feat: add getLatestComments query"
```

---

### Task 4: Add `extractListingInfo` DOM scraping utility

**Files:**
- Create: `extension/src/utils/listingInfo.ts`

**Step 1: Create the utility**

This function scrapes car metadata from the listing detail page DOM. The selectors target polovniautomobili.com's listing page structure.

```typescript
export interface ListingInfo {
  title: string;
  price: string;
  imageUrl: string;
  url: string;
}

export function extractListingInfo(): ListingInfo | null {
  try {
    const titleEl = document.querySelector("h1.uk-article-title");
    const priceEl = document.querySelector(".price-item .regularPriceColor");
    const imageEl = document.querySelector(
      ".pi-img-wrapper img"
    ) as HTMLImageElement | null;

    const title = titleEl?.textContent?.trim() ?? "";
    const price = priceEl?.textContent?.trim() ?? "";
    const imageUrl = imageEl?.src ?? "";

    if (!title) return null;

    return {
      title,
      price,
      imageUrl,
      url: window.location.href,
    };
  } catch {
    return null;
  }
}
```

Note: The CSS selectors above are best-guesses and MUST be verified against the actual polovniautomobili.com DOM during implementation. Open a listing page, inspect the DOM, and adjust selectors as needed.

**Step 2: Build and verify**

Run: `npm run build && rm -f convex/*.js`
Expected: Build succeeds.

**Step 3: Commit**

```bash
git add extension/src/utils/listingInfo.ts
git commit -m "feat: add extractListingInfo DOM scraping utility"
```

---

### Task 5: Update content script to work on all pages

**Files:**
- Modify: `extension/src/content/index.tsx`
- Modify: `extension/manifest.json`

**Step 1: Update manifest match pattern**

Change `extension/manifest.json` content_scripts matches to:

```json
"matches": ["https://www.polovniautomobili.com/*"]
```

**Step 2: Update content script**

The content script should now mount the app on all pages. `listingId` becomes optional ‚Äî it's `null` on non-listing pages.

```typescript
import React from "react";
import { createRoot } from "react-dom/client";
import { extractListingId } from "../utils/listingId";
import { extractListingInfo } from "../utils/listingInfo";
import { getOrCreateAnonymousId } from "../utils/anonymousId";
import { getOrCreateUsername } from "../utils/username";
import App from "../components/App";
import styles from "./shadow.css?inline";

function main() {
  const listingId = extractListingId(window.location.href);
  const listingInfo = listingId ? extractListingInfo() : null;

  const anonymousId = getOrCreateAnonymousId();
  const {
    username: initialUsername,
    isAutoGenerated: initialIsAutoGenerated,
  } = getOrCreateUsername();

  const host = document.createElement("div");
  host.id = "pa-comments-host";
  document.body.appendChild(host);

  const shadow = host.attachShadow({ mode: "open" });

  const style = document.createElement("style");
  style.textContent = styles;
  shadow.appendChild(style);

  const portalTarget = document.createElement("div");
  portalTarget.style.pointerEvents = "none";
  shadow.appendChild(portalTarget);

  const container = document.createElement("div");
  shadow.appendChild(container);

  const hostStyle = document.createElement("style");
  hostStyle.textContent =
    "#pa-comments-host { position: relative; z-index: 2147483647; }";
  document.head.appendChild(hostStyle);

  createRoot(container).render(
    <React.StrictMode>
      <App
        listingId={listingId}
        anonymousId={anonymousId}
        portalContainer={portalTarget}
        initialUsername={initialUsername}
        initialIsAutoGenerated={initialIsAutoGenerated}
        listingInfo={listingInfo}
      />
    </React.StrictMode>
  );
}

main();
```

**Step 3: Build and verify**

Run: `npm run build && rm -f convex/*.js`
Expected: Build will fail because App doesn't accept `listingInfo` or optional `listingId` yet. That's expected ‚Äî we fix it in the next task.

**Step 4: Commit**

```bash
git add extension/src/content/index.tsx extension/manifest.json
git commit -m "feat: broaden content script to all polovniautomobili.com pages"
```

---

### Task 6: Update App component to handle optional listingId and upsert listing

**Files:**
- Modify: `extension/src/components/App.tsx`

**Step 1: Update App to accept optional listingId and listingInfo**

The App component needs to:
1. Accept `listingId` as `string | null` and `listingInfo` as optional
2. Call `upsertListing` when posting a comment (if listingInfo is available)
3. Pass the active tab context down to Drawer

```typescript
import { ConvexProvider, ConvexReactClient, useQuery, useMutation } from "convex/react";
import { useCallback, useState } from "react";
import { api } from "../../convex/_generated/api";
import { Id } from "../../convex/_generated/dataModel";
import { Drawer } from "./Drawer";
import { Comment } from "./CommentItem";
import { ShadowPortalContext } from "../context/shadow-portal";
import { saveUsername } from "../utils/username";
import { ListingInfo } from "../utils/listingInfo";

const convex = new ConvexReactClient(import.meta.env.VITE_CONVEX_URL as string);

interface AppProps {
  listingId: string | null;
  anonymousId: string;
  portalContainer: HTMLElement;
  initialUsername: string;
  initialIsAutoGenerated: boolean;
  listingInfo: ListingInfo | null;
}

function countAllComments(comments: Comment[]): number {
  return comments.reduce((sum, c) => sum + 1 + (c.replies?.length ?? 0), 0);
}

function CommentApp({
  listingId,
  anonymousId,
  initialUsername,
  initialIsAutoGenerated,
  listingInfo,
}: Omit<AppProps, "portalContainer">) {
  const commentsRaw = useQuery(
    api.comments.getComments,
    listingId ? { listingId } : "skip"
  );
  const latestComments = useQuery(api.comments.getLatestComments);
  const voteMutation = useMutation(api.votes.vote);
  const postMutation = useMutation(api.comments.postComment);
  const upsertListingMutation = useMutation(api.listings.upsertListing);
  const [error, setError] = useState<string | null>(null);
  const [localVotes, setLocalVotes] = useState<
    Record<string, "up" | "down" | null>
  >({});
  const [username, setUsername] = useState(initialUsername);
  const [isAutoGenerated, setIsAutoGenerated] = useState(
    initialIsAutoGenerated
  );

  const comments: Comment[] = (commentsRaw ?? []) as Comment[];

  const handleUsernameChange = useCallback(
    (newUsername: string, autoGenerated: boolean) => {
      if (autoGenerated) {
        setIsAutoGenerated(true);
        saveUsername(username, true);
      } else {
        setUsername(newUsername);
        setIsAutoGenerated(false);
        saveUsername(newUsername, false);
      }
    },
    [username]
  );

  const handleVote = useCallback(
    async (commentId: string, direction: "up" | "down") => {
      const prev = localVotes[commentId] ?? null;
      const next = prev === direction ? null : direction;
      setLocalVotes((v) => ({ ...v, [commentId]: next }));
      try {
        await voteMutation({
          commentId: commentId as Id<"comments">,
          voterId: anonymousId,
          direction,
        });
      } catch {
        setLocalVotes((v) => ({ ...v, [commentId]: prev }));
      }
    },
    [localVotes, voteMutation, anonymousId]
  );

  const handlePost = useCallback(
    async (text: string) => {
      if (!listingId) return;
      if (listingInfo) {
        await upsertListingMutation({
          listingId,
          ...listingInfo,
        });
      }
      await postMutation({
        listingId,
        text,
        authorId: anonymousId,
        username,
        isAutoGenerated,
      });
    },
    [
      postMutation,
      upsertListingMutation,
      listingId,
      listingInfo,
      anonymousId,
      username,
      isAutoGenerated,
    ]
  );

  const handleReply = useCallback(
    async (parentId: string, text: string) => {
      if (!listingId) return;
      if (listingInfo) {
        await upsertListingMutation({
          listingId,
          ...listingInfo,
        });
      }
      await postMutation({
        listingId,
        text,
        authorId: anonymousId,
        parentId: parentId as Id<"comments">,
        username,
        isAutoGenerated,
      });
    },
    [
      postMutation,
      upsertListingMutation,
      listingId,
      listingInfo,
      anonymousId,
      username,
      isAutoGenerated,
    ]
  );

  const mergedVotes = {
    ...Object.fromEntries(
      Object.entries(localVotes).filter(([, v]) => v !== null) as [
        string,
        "up" | "down",
      ][]
    ),
  };

  const connectionError = commentsRaw === undefined ? error : null;

  return (
    <Drawer
      listingId={listingId}
      comments={comments}
      commentCount={countAllComments(comments)}
      latestComments={latestComments ?? []}
      currentVotes={mergedVotes}
      onVote={handleVote}
      onPost={handlePost}
      onReply={handleReply}
      error={connectionError}
      onRetry={() => setError(null)}
      anonymousId={anonymousId}
      username={username}
      isAutoGenerated={isAutoGenerated}
      onUsernameChange={handleUsernameChange}
    />
  );
}

export default function App({ portalContainer, ...props }: AppProps) {
  return (
    <ShadowPortalContext.Provider value={portalContainer}>
      <ConvexProvider client={convex}>
        <CommentApp {...props} />
      </ConvexProvider>
    </ShadowPortalContext.Provider>
  );
}
```

**Step 2: Build and verify**

Run: `npm run build && rm -f convex/*.js`
Expected: Build will fail because Drawer doesn't accept the new props yet. That's expected ‚Äî we fix it in the next task.

**Step 3: Commit**

```bash
git add extension/src/components/App.tsx
git commit -m "feat: update App to handle optional listingId and upsert listing"
```

---

### Task 7: Add tab navigation and latest feed to Drawer

**Files:**
- Modify: `extension/src/components/Drawer.tsx`
- Create: `extension/src/components/LatestFeedItem.tsx`

**Step 1: Create the LatestFeedItem component**

This is a read-only comment card with a car preview for the global feed.

```typescript
import { User } from "lucide-react";

export interface LatestComment {
  _id: string;
  text: string;
  username: string;
  isAutoGenerated: boolean;
  createdAt: number;
  listing: {
    title: string;
    price: string;
    imageUrl: string;
    url: string;
  } | null;
}

interface Props {
  comment: LatestComment;
}

export function LatestFeedItem({ comment }: Props) {
  const timeAgo = formatTimeAgo(comment.createdAt);

  return (
    <div className="py-3 border-b border-gray-100 last:border-0">
      {comment.listing && (
        <a
          href={comment.listing.url}
          target="_top"
          className="flex gap-2 mb-2 p-2 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors no-underline"
        >
          {comment.listing.imageUrl && (
            <img
              src={comment.listing.imageUrl}
              alt=""
              className="w-16 h-12 object-cover rounded shrink-0"
            />
          )}
          <div className="min-w-0">
            <p className="text-xs font-medium text-gray-800 truncate">
              {comment.listing.title}
            </p>
            <p className="text-xs text-orange-600 font-semibold">
              {comment.listing.price}
            </p>
          </div>
        </a>
      )}

      <div className="flex gap-2">
        <div className="shrink-0 w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center">
          <User className="h-3 w-3 text-gray-400" />
        </div>
        <div className="min-w-0">
          <p
            className={`text-xs font-medium mb-0.5 ${comment.isAutoGenerated ? "italic text-gray-400" : "text-gray-600"}`}
          >
            {comment.username}
          </p>
          <p className="text-sm text-gray-800 break-words leading-snug">
            {comment.text}
          </p>
          <p className="text-xs text-gray-400 mt-1">{timeAgo}</p>
        </div>
      </div>
    </div>
  );
}

function formatTimeAgo(timestamp: number): string {
  const diff = Date.now() - timestamp;
  const minutes = Math.floor(diff / 60_000);
  if (minutes < 1) return "upravo";
  if (minutes < 60) return `pre ${minutes} min`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `pre ${hours}h`;
  const days = Math.floor(hours / 24);
  if (days < 7) return `pre ${days}d`;
  const weeks = Math.floor(days / 7);
  return `pre ${weeks}n`;
}
```

**Step 2: Update Drawer with tab navigation**

Replace the full content of `extension/src/components/Drawer.tsx`:

```typescript
import { useState, useEffect, useRef } from "react";
import { Comment, CommentItem } from "./CommentItem";
import { LatestComment, LatestFeedItem } from "./LatestFeedItem";
import { PostForm } from "./PostForm";
import { X } from "lucide-react";

type Tab = "listing" | "latest";

interface Props {
  listingId: string | null;
  comments: Comment[];
  commentCount: number;
  latestComments: LatestComment[];
  currentVotes: Record<string, "up" | "down">;
  onVote: (commentId: string, direction: "up" | "down") => void;
  onPost: (text: string) => Promise<void>;
  onReply: (parentId: string, text: string) => Promise<void>;
  error: string | null;
  onRetry: () => void;
  anonymousId: string;
  username: string;
  isAutoGenerated: boolean;
  onUsernameChange: (username: string, isAutoGenerated: boolean) => void;
}

const DRAWER_STATE_KEY = "paCommentsDrawerOpen";

export function Drawer({
  listingId,
  comments,
  commentCount,
  latestComments,
  currentVotes,
  onVote,
  onPost,
  onReply,
  error,
  onRetry,
  anonymousId,
  username,
  isAutoGenerated,
  onUsernameChange,
}: Props) {
  const [open, setOpen] = useState(false);
  const [animating, setAnimating] = useState(false);
  const [activeTab, setActiveTab] = useState<Tab>(
    listingId ? "listing" : "latest"
  );
  const panelRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (localStorage.getItem(DRAWER_STATE_KEY) === "true") setOpen(true);
  }, []);

  function toggle() {
    if (animating) return;
    const next = !open;
    setAnimating(true);
    setOpen(next);
    localStorage.setItem(DRAWER_STATE_KEY, String(next));
  }

  return (
    <div
      ref={panelRef}
      style={{
        position: "fixed",
        zIndex: 2147483647,
        top: 0,
        right: 0,
        height: "100dvh",
        width: "30%",
        transform: open ? "translateX(0)" : "translateX(100%)",
        transition: "transform 500ms ease-in-out",
      }}
      onTransitionEnd={() => setAnimating(false)}
    >
      {/* Toggle tab */}
      <button
        onClick={toggle}
        disabled={animating}
        style={{ transform: "translateX(-100%) translateY(-50%)" }}
        className="absolute left-0 top-1/2 flex flex-col items-center justify-center gap-1 bg-orange-500 text-white w-9 rounded-l-lg p-6 shadow-lg hover:bg-orange-600 disabled:opacity-80"
        aria-label="Toggle comments"
      >
        <span className="text-lg leading-none">üí¨</span>
        {listingId && commentCount > 0 && (
          <span className="text-[20px] font-bold leading-none">
            {commentCount > 99 ? "99+" : commentCount}
          </span>
        )}
      </button>

      {/* Drawer panel */}
      <div
        className="h-full bg-background flex flex-col"
        style={{ boxShadow: "-4px 0 16px rgba(0, 0, 0, 0.12)" }}
      >
        {/* Header */}
        <div className="px-4 py-3 border-b border-border shrink-0 flex items-center justify-between">
          <h2 className="text-sm font-semibold text-foreground">Komentari</h2>
          <button
            onClick={toggle}
            disabled={animating}
            className="rounded-sm opacity-70 hover:opacity-100"
            aria-label="Close"
          >
            <X className="h-4 w-4" />
          </button>
        </div>

        {/* Tabs */}
        {listingId && (
          <div className="flex border-b border-border shrink-0">
            <button
              onClick={() => setActiveTab("listing")}
              className={`flex-1 text-xs py-2 font-medium transition-colors ${
                activeTab === "listing"
                  ? "text-orange-500 border-b-2 border-orange-500"
                  : "text-muted-foreground hover:text-foreground"
              }`}
            >
              –û–≤–∞—ò –æ–≥–ª–∞—Å
              {commentCount > 0 && (
                <span className="ml-1 text-muted-foreground font-normal">
                  ({commentCount})
                </span>
              )}
            </button>
            <button
              onClick={() => setActiveTab("latest")}
              className={`flex-1 text-xs py-2 font-medium transition-colors ${
                activeTab === "latest"
                  ? "text-orange-500 border-b-2 border-orange-500"
                  : "text-muted-foreground hover:text-foreground"
              }`}
            >
              –ù–∞—ò–Ω–æ–≤–∏—ò–µ
            </button>
          </div>
        )}

        {/* Listing tab content */}
        {activeTab === "listing" && listingId && (
          <>
            <div className="shrink-0">
              <PostForm
                onPost={onPost}
                username={username}
                isAutoGenerated={isAutoGenerated}
                onUsernameChange={onUsernameChange}
              />
            </div>

            <div className="flex-1 overflow-y-auto px-3">
              {error ? (
                <div className="flex flex-col items-center gap-2 py-8 text-center">
                  <p className="text-sm text-gray-500">{error}</p>
                  <button
                    onClick={onRetry}
                    className="text-sm text-orange-500 hover:underline"
                  >
                    Pokreni ponovo
                  </button>
                </div>
              ) : comments.length === 0 ? (
                <p className="text-sm text-gray-400 text-center py-8">
                  Nema komentara jo≈° uvek. Napi≈°i prvi!
                </p>
              ) : (
                comments.map((c) => (
                  <CommentItem
                    key={c._id}
                    comment={c}
                    currentVotes={currentVotes}
                    onVote={onVote}
                    onReply={onReply}
                    anonymousId={anonymousId}
                  />
                ))
              )}
            </div>
          </>
        )}

        {/* Latest tab content */}
        {activeTab === "latest" && (
          <div className="flex-1 overflow-y-auto px-3">
            {latestComments.length === 0 ? (
              <p className="text-sm text-gray-400 text-center py-8">
                Nema komentara jo≈° uvek.
              </p>
            ) : (
              latestComments.map((c) => (
                <LatestFeedItem key={c._id} comment={c} />
              ))
            )}
          </div>
        )}
      </div>
    </div>
  );
}
```

**Step 3: Build and verify**

Run: `npm run build && rm -f convex/*.js`
Expected: Build succeeds.

**Step 4: Commit**

```bash
git add extension/src/components/LatestFeedItem.tsx extension/src/components/Drawer.tsx
git commit -m "feat: add tab navigation and latest comments feed to drawer"
```

---

### Task 8: Manual testing and selector verification

**Files:** No file changes ‚Äî this is a verification task.

**Step 1: Verify DOM selectors**

Open a listing page on polovniautomobili.com in Chrome DevTools. Verify these selectors from `extractListingInfo()` match the actual DOM:
- `h1.uk-article-title` ‚Üí car title
- `.price-item .regularPriceColor` ‚Üí price
- `.pi-img-wrapper img` ‚Üí main image

If selectors are wrong, update `extension/src/utils/listingInfo.ts` accordingly.

**Step 2: Test listing page**

1. Load the extension on a listing detail page
2. Verify the drawer opens with two tabs: "–û–≤–∞—ò –æ–≥–ª–∞—Å" and "–ù–∞—ò–Ω–æ–≤–∏—ò–µ"
3. Default tab should be "–û–≤–∞—ò –æ–≥–ª–∞—Å"
4. Post a comment ‚Äî verify it appears in both tabs
5. Switch to "–ù–∞—ò–Ω–æ–≤–∏—ò–µ" ‚Äî verify the comment shows with car preview

**Step 3: Test non-listing page**

1. Navigate to the search results page or homepage
2. Verify the drawer opens with only the "–ù–∞—ò–Ω–æ–≤–∏—ò–µ" tab (no tab bar shown)
3. Verify latest comments load with car preview cards
4. Click a car preview card ‚Äî verify it navigates to the listing

**Step 4: Commit any selector fixes**

```bash
git add -A && git commit -m "fix: adjust DOM selectors for listing info extraction"
```
