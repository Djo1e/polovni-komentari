# Username Feature Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add optional username to comments, with auto-generated Serbian car-themed names as defaults, visually distinct from custom names.

**Architecture:** Username stored on each comment record alongside `isAutoGenerated` flag. Username persisted in Chrome storage. Random name generator picks from car brand list + 2-3 digit number. PostForm gets a username input above the textarea. CommentItem displays username with different styling for auto-generated vs custom.

**Tech Stack:** Convex (backend), React + Tailwind (UI), Chrome storage

---

### Task 1: Create username utility

**Files:**
- Create: `src/utils/username.ts`
- Create: `src/utils/username.test.ts`

**Step 1: Write the utility**

```typescript
// src/utils/username.ts

const CAR_BRANDS = [
  "Golf", "Punto", "Pezo", "Astra", "Jugo", "Stojadin", "Fica", "Yugo",
  "Clio", "Megane", "Octavia", "Fabia", "Polo", "Corsa", "Leon", "Ibiza",
  "Tipo", "Brava", "Uno", "Kadett", "Lada", "Niva", "Zastava", "Skala", "Koral",
];

export function generateRandomUsername(): string {
  const brand = CAR_BRANDS[Math.floor(Math.random() * CAR_BRANDS.length)];
  const num = Math.floor(Math.random() * 900 + 100); // 100-999
  return `${brand}${num}`;
}

const USERNAME_KEY = "paCommentsUsername";
const AUTO_GENERATED_KEY = "paCommentsUsernameAutoGenerated";

export interface StoredUsername {
  username: string;
  isAutoGenerated: boolean;
}

export async function getOrCreateUsername(): Promise<StoredUsername> {
  const result = await chrome.storage.local.get([USERNAME_KEY, AUTO_GENERATED_KEY]);
  if (result[USERNAME_KEY]) {
    return {
      username: result[USERNAME_KEY] as string,
      isAutoGenerated: result[AUTO_GENERATED_KEY] !== false,
    };
  }

  const username = generateRandomUsername();
  await chrome.storage.local.set({
    [USERNAME_KEY]: username,
    [AUTO_GENERATED_KEY]: true,
  });
  return { username, isAutoGenerated: true };
}

export async function saveUsername(username: string, isAutoGenerated: boolean): Promise<void> {
  await chrome.storage.local.set({
    [USERNAME_KEY]: username,
    [AUTO_GENERATED_KEY]: isAutoGenerated,
  });
}
```

**Step 2: Write tests for generateRandomUsername**

```typescript
// src/utils/username.test.ts
import { describe, it, expect } from "vitest";
import { generateRandomUsername } from "./username";

describe("generateRandomUsername", () => {
  it("returns a string matching CarBrand + 3-digit number pattern", () => {
    const name = generateRandomUsername();
    expect(name).toMatch(/^[A-Z][a-z]+\d{3}$/);
  });

  it("generates different names on repeated calls", () => {
    const names = new Set(Array.from({ length: 20 }, () => generateRandomUsername()));
    expect(names.size).toBeGreaterThan(1);
  });
});
```

**Step 3: Run tests**

Run: `npx vitest run src/utils/username.test.ts`
Expected: 2 tests pass

**Step 4: Commit**

```bash
git add src/utils/username.ts src/utils/username.test.ts
git commit -m "feat: add username utility with random car-themed name generator"
```

---

### Task 2: Update schema and postComment mutation

**Files:**
- Modify: `convex/schema.ts`
- Modify: `convex/comments.ts`

**Step 1: Add username and isAutoGenerated to schema**

In `convex/schema.ts`, add to comments table:

```typescript
comments: defineTable({
  listingId: v.string(),
  authorId: v.string(),
  text: v.string(),
  createdAt: v.number(),
  parentId: v.optional(v.id("comments")),
  username: v.string(),
  isAutoGenerated: v.boolean(),
})
```

**Step 2: Update postComment args and insert**

In `convex/comments.ts`, add `username` and `isAutoGenerated` to the mutation args:

```typescript
export const postComment = mutation({
  args: {
    listingId: v.string(),
    text: v.string(),
    authorId: v.string(),
    parentId: v.optional(v.id("comments")),
    username: v.string(),
    isAutoGenerated: v.boolean(),
  },
  handler: async (ctx, { listingId, text, authorId, parentId, username, isAutoGenerated }) => {
    const trimmed = text.trim();
    if (trimmed.length === 0) throw new Error("Comment cannot be empty");
    if (trimmed.length > 1000) throw new Error("Comment too long");

    if (parentId) {
      const parent = await ctx.db.get(parentId);
      if (!parent) throw new Error("Parent comment not found");
      if (parent.listingId !== listingId)
        throw new Error("Parent belongs to different listing");
      if (parent.parentId) throw new Error("Cannot reply to a reply");
    }

    return ctx.db.insert("comments", {
      listingId,
      authorId,
      text: trimmed,
      createdAt: Date.now(),
      username,
      isAutoGenerated,
      ...(parentId ? { parentId } : {}),
    });
  },
});
```

**Step 3: Commit**

```bash
git add convex/schema.ts convex/comments.ts
git commit -m "feat: add username and isAutoGenerated to comments schema and mutation"
```

---

### Task 3: Update CommentItem to display username

**Files:**
- Modify: `src/components/CommentItem.tsx`

**Step 1: Add username and isAutoGenerated to Comment interface**

Add to the `Comment` interface:

```typescript
export interface Comment {
  _id: Id<"comments">;
  text: string;
  score: number;
  createdAt: number;
  authorId: string;
  parentId?: Id<"comments">;
  replies?: Comment[];
  username: string;
  isAutoGenerated: boolean;
}
```

**Step 2: Display username in the comment**

Replace the avatar section and add username display. Between the avatar and the comment text, add the username:

Replace this block (lines 56-57):
```tsx
        <div className="flex-1 min-w-0">
          <p className="text-sm text-gray-800 break-words leading-snug">{comment.text}</p>
```

With:
```tsx
        <div className="flex-1 min-w-0">
          <p className={`text-xs font-medium mb-0.5 ${comment.isAutoGenerated ? "italic text-gray-400" : "text-gray-600"}`}>
            {comment.username}
          </p>
          <p className="text-sm text-gray-800 break-words leading-snug">{comment.text}</p>
```

**Step 3: Commit**

```bash
git add src/components/CommentItem.tsx
git commit -m "feat: display username on comments with distinct auto-generated styling"
```

---

### Task 4: Update PostForm with username input

**Files:**
- Modify: `src/components/PostForm.tsx`

**Step 1: Add username props and input field**

Update PostForm to accept and manage username:

```tsx
import { useState } from "react";
import { Button } from "@/components/ui/button";
import { Textarea } from "@/components/ui/textarea";

interface Props {
  onPost: (text: string) => Promise<void>;
  username: string;
  isAutoGenerated: boolean;
  onUsernameChange: (username: string, isAutoGenerated: boolean) => void;
}

export function PostForm({ onPost, username, isAutoGenerated, onUsernameChange }: Props) {
  const [text, setText] = useState("");
  const [error, setError] = useState<string | null>(null);
  const [posting, setPosting] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!text.trim()) return;
    setPosting(true);
    setError(null);
    try {
      await onPost(text);
      setText("");
    } catch {
      setError("Failed to post. Please try again.");
    } finally {
      setPosting(false);
    }
  }

  function handleUsernameChange(value: string) {
    onUsernameChange(value, false);
  }

  function handleUsernameBlur() {
    if (!username.trim()) {
      // Will be regenerated by parent
      onUsernameChange("", true);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="p-3 border-b border-gray-200">
      <input
        type="text"
        value={username}
        onChange={(e) => handleUsernameChange(e.target.value)}
        onBlur={handleUsernameBlur}
        placeholder="Username (optional)"
        maxLength={30}
        className={`w-full text-xs px-2 py-1.5 mb-2 rounded border border-gray-200 bg-transparent outline-none focus:border-orange-400 ${isAutoGenerated ? "italic text-gray-400" : "text-gray-700"}`}
        disabled={posting}
      />
      <Textarea
        value={text}
        onChange={(e) => setText(e.target.value)}
        placeholder="Leave a comment..."
        maxLength={1000}
        rows={3}
        className="resize-none text-sm"
        disabled={posting}
      />
      {error && <p className="text-xs text-red-500 mt-1">{error}</p>}
      <div className="flex justify-between items-center mt-2">
        <span className="text-xs text-gray-400">{text.length}/1000</span>
        <Button
          type="submit"
          disabled={!text.trim() || posting}
          className="bg-orange-500 text-white hover:bg-orange-600"
          size="sm"
        >
          {posting ? "Postingâ€¦" : "Post"}
        </Button>
      </div>
    </form>
  );
}
```

**Step 2: Commit**

```bash
git add src/components/PostForm.tsx
git commit -m "feat: add username input to PostForm with auto-generated styling"
```

---

### Task 5: Wire up username in App.tsx and content/index.tsx

**Files:**
- Modify: `src/components/App.tsx`
- Modify: `src/components/Drawer.tsx`
- Modify: `src/content/index.tsx`

**Step 1: Update content/index.tsx to load username**

Add username loading alongside anonymousId:

```tsx
import { getOrCreateUsername } from "../utils/username";

// In main(), after anonymousId:
const { username: initialUsername, isAutoGenerated: initialIsAutoGenerated } = await getOrCreateUsername();

// Update App render:
<App
  listingId={listingId}
  anonymousId={anonymousId}
  portalContainer={portalTarget}
  initialUsername={initialUsername}
  initialIsAutoGenerated={initialIsAutoGenerated}
/>
```

**Step 2: Update App.tsx**

Add username state, pass through to Drawer, update handlePost and handleReply to include username:

```tsx
import { ConvexProvider, ConvexReactClient, useQuery, useMutation } from "convex/react";
import { useCallback, useState } from "react";
import { api } from "../../convex/_generated/api";
import { Id } from "../../convex/_generated/dataModel";
import { Drawer } from "./Drawer";
import { Comment } from "./CommentItem";
import { ShadowPortalContext } from "../context/shadow-portal";
import { saveUsername, generateRandomUsername } from "../utils/username";

const convex = new ConvexReactClient(import.meta.env.VITE_CONVEX_URL as string);

interface AppProps {
  listingId: string;
  anonymousId: string;
  portalContainer: HTMLElement;
  initialUsername: string;
  initialIsAutoGenerated: boolean;
}

function countAllComments(comments: Comment[]): number {
  return comments.reduce((sum, c) => sum + 1 + (c.replies?.length ?? 0), 0);
}

function CommentApp({ listingId, anonymousId, initialUsername, initialIsAutoGenerated }: Omit<AppProps, "portalContainer">) {
  const commentsRaw = useQuery(api.comments.getComments, { listingId });
  const voteMutation = useMutation(api.votes.vote);
  const postMutation = useMutation(api.comments.postComment);
  const [error, setError] = useState<string | null>(null);
  const [localVotes, setLocalVotes] = useState<Record<string, "up" | "down" | null>>({});
  const [username, setUsername] = useState(initialUsername);
  const [isAutoGenerated, setIsAutoGenerated] = useState(initialIsAutoGenerated);

  const comments: Comment[] = (commentsRaw ?? []) as Comment[];

  const handleUsernameChange = useCallback((newUsername: string, autoGenerated: boolean) => {
    if (autoGenerated && !newUsername) {
      const generated = generateRandomUsername();
      setUsername(generated);
      setIsAutoGenerated(true);
      saveUsername(generated, true);
    } else {
      setUsername(newUsername);
      setIsAutoGenerated(autoGenerated);
      saveUsername(newUsername, autoGenerated);
    }
  }, []);

  const handleVote = useCallback(
    async (commentId: string, direction: "up" | "down") => {
      const prev = localVotes[commentId] ?? null;
      const next = prev === direction ? null : direction;
      setLocalVotes((v) => ({ ...v, [commentId]: next }));
      try {
        await voteMutation({
          commentId: commentId as Id<"comments">,
          voterId: anonymousId,
          direction,
        });
      } catch {
        setLocalVotes((v) => ({ ...v, [commentId]: prev }));
      }
    },
    [localVotes, voteMutation, anonymousId]
  );

  const handlePost = useCallback(
    async (text: string) => {
      await postMutation({ listingId, text, authorId: anonymousId, username, isAutoGenerated });
    },
    [postMutation, listingId, anonymousId, username, isAutoGenerated]
  );

  const handleReply = useCallback(
    async (parentId: string, text: string) => {
      await postMutation({
        listingId,
        text,
        authorId: anonymousId,
        parentId: parentId as Id<"comments">,
        username,
        isAutoGenerated,
      });
    },
    [postMutation, listingId, anonymousId, username, isAutoGenerated]
  );

  const mergedVotes = {
    ...Object.fromEntries(
      Object.entries(localVotes).filter(([, v]) => v !== null) as [string, "up" | "down"][]
    ),
  };

  const connectionError = commentsRaw === undefined ? error : null;

  return (
    <Drawer
      comments={comments}
      commentCount={countAllComments(comments)}
      currentVotes={mergedVotes}
      onVote={handleVote}
      onPost={handlePost}
      onReply={handleReply}
      error={connectionError}
      onRetry={() => setError(null)}
      anonymousId={anonymousId}
      username={username}
      isAutoGenerated={isAutoGenerated}
      onUsernameChange={handleUsernameChange}
    />
  );
}

export default function App({ portalContainer, ...props }: AppProps) {
  return (
    <ShadowPortalContext.Provider value={portalContainer}>
      <ConvexProvider client={convex}>
        <CommentApp {...props} />
      </ConvexProvider>
    </ShadowPortalContext.Provider>
  );
}
```

**Step 3: Update Drawer.tsx props**

Add username props to Drawer's Props interface and pass to PostForm:

```
Add to Props interface:
  username: string;
  isAutoGenerated: boolean;
  onUsernameChange: (username: string, isAutoGenerated: boolean) => void;

Destructure in component params.

Update PostForm usage:
  <PostForm
    onPost={onPost}
    username={username}
    isAutoGenerated={isAutoGenerated}
    onUsernameChange={onUsernameChange}
  />
```

**Step 4: Commit**

```bash
git add src/content/index.tsx src/components/App.tsx src/components/Drawer.tsx
git commit -m "feat: wire up username state through App, Drawer, and PostForm"
```

---

### Task 6: Build and verify

**Step 1: Run TypeScript check**

Run: `npx tsc --noEmit`
Expected: no errors

**Step 2: Run tests**

Run: `npx vitest run`
Expected: all tests pass

**Step 3: Run build**

Run: `npm run build`
Expected: successful build

**Step 4: Commit any fixes if needed**
